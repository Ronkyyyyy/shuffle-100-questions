<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚·ãƒ£ãƒƒãƒ•ãƒ«100ã®è³ªå•ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <style>
        /* --- ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆåŸºæœ¬å¤‰æ›´ãªã—ï¼‰ --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            padding: 24px;
            text-align: center;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        h1 { font-size: 22px; margin-bottom: 20px; color: #444; }
        h2 { font-size: 16px; color: #888; margin-bottom: 10px; }

        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 8px;
            font-weight: bold;
            width: 80%;
            max-width: 300px;
            touch-action: manipulation;
        }
        .btn:hover { background-color: #0056b3; transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #545b62; }
        .btn:disabled, .btn.disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .settings-group { margin-bottom: 24px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        
        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å¤§ããè¦‹ã‚„ã™ã */
        input[type="range"] { 
            width: 100%; 
            margin-top: 10px; 
            cursor: pointer;
        }

        .question-card {
            font-size: 26px; line-height: 1.6; margin: 40px 0; font-weight: bold; word-break: break-all;
        }
        
        .shuffled-word {
            display: inline-block; background-color: #333; color: transparent;
            padding: 4px 12px; border-radius: 8px; cursor: pointer; user-select: none;
            transition: all 0.3s ease; min-width: 70px; text-align: center;
            position: relative; vertical-align: middle; margin: 0 4px;
        }
        .shuffled-word.revealed {
            background-color: #ffeb3b; color: #d32f2f; transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .shuffled-word:not(.revealed)::after {
            content: "???"; color: white; position: absolute;
            left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 16px;
        }

        .result-list { text-align: left; max-height: 50vh; overflow-y: auto; margin-bottom: 20px; padding-right: 5px; }
        .result-item { background: #fafafa; margin-bottom: 12px; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
        .result-q { font-weight: bold; font-size: 16px; margin-bottom: 6px; color: #333; }
        .original-text { font-size: 13px; color: #999; margin-left: 2px; }

        .screen { display: none; height: 100%; width: 100%; flex-direction: column; justify-content: space-between; }
        .screen.active { display: flex; }
        .footer-actions { margin-top: auto; width: 100%; display: flex; flex-direction: column; align-items: center; }

        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8); color: white; padding: 10px 24px;
            border-radius: 30px; opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        #toast.show { opacity: 1; }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 1000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #007bff; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="loader"></div>
    <div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div class="container">
    <div id="screen-setup" class="screen">
        <div>
            <h1>ğŸ”€ ã‚·ãƒ£ãƒƒãƒ•ãƒ«100ã®è³ªå•</h1>
            
            <div class="settings-group">
                <label>è³ªå•æ•°: <span id="count-display">10</span>å•</label>
                <input type="range" id="q-count" min="1" max="100" value="10" step="1">
            </div>
            
            <div id="data-status" style="font-size: 12px; color: #888; margin-top: 10px;">
                </div>
        </div>

        <div class="footer-actions">
            <button class="btn" onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        </div>
    </div>

    <div id="screen-play" class="screen">
        <div>
            <h2 id="question-counter">Q. 1 / 5</h2>
            <div class="question-card" id="question-text"></div>
        </div>
        
        <div class="footer-actions">
            <button id="next-btn" class="btn" onclick="nextQuestion()" disabled>æ¬¡ã®è³ªå•ã¸</button>
            <button class="btn btn-secondary" onclick="resetGame()" style="font-size:12px; padding: 8px 16px;">ä¸­æ–­ã™ã‚‹</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div>
            <h1>ğŸ‰ çµ‚äº†ï¼</h1>
            <div class="result-list" id="result-list"></div>
        </div>
        
        <div class="footer-actions">
            <button class="btn" onclick="copyResults()">ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
            <button class="btn btn-secondary" onclick="resetGame()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
        </div>
    </div>
</div>

<div id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>

<script>
    // â˜…â˜…â˜…ã“ã“ã«ç™ºè¡Œã•ã‚ŒãŸGASã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„â˜…â˜…â˜…
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyavsPH5s6J6E3MQR6zSXqrkOzzAxAG20AX0xWc5BBABz040z5n6Xeo0sWNk791IiaC/exec"; 
    
    // --- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼æ™‚ã®ä¿é™ºï¼‰ ---
    const fallbackDatabase = [
        { template: "ï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰ã‚ãªãŸã®[%s]ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", words: ["å‡ºèº«åœ°"], category: "default" },
        { template: "ï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰è¶£å‘³ã¯[%s]ã§ã™ã‹ï¼Ÿ", words: ["èª­æ›¸"], category: "default" },
        { template: "ï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰[%s]ã¨[%s]ã€ã©ã£ã¡ãŒå¤§äº‹ï¼Ÿ", words: ["æ„›", "ãŠé‡‘"], category: "default" }
    ];

    let database = []; 
    let currentQuestions = []; 
    let currentIndex = 0;
    let revealedCount = 0;
    let totalSlotsInCurrent = 0;

    // --- èµ·å‹•æ™‚ã®ãƒ‡ãƒ¼ã‚¿å–å¾— ---
    window.addEventListener('load', async () => {
        const overlay = document.getElementById('loading-overlay');
        const statusEl = document.getElementById('data-status');

        if (!GAS_API_URL) {
            console.warn("GAS_API_URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
            database = fallbackDatabase; 
            overlay.style.display = 'none';
            showScreen('screen-setup');
            statusEl.textContent = "â€»ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆURLæœªè¨­å®šï¼‰";
            return;
        }

        try {
            const response = await fetch(GAS_API_URL);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            
            database = data; 
            statusEl.textContent = `â€»${database.length}å•ä¸­ã„ãã¤ç­”ãˆã¾ã™ã‹ï¼Ÿ`;
        } catch (error) {
            console.error('Fetch error:', error);
            database = fallbackDatabase; 
            alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ãƒ‡ãƒ¼ã‚¿ã§èµ·å‹•ã—ã¾ã™ã€‚");
            statusEl.textContent = "â€»é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼‰";
        } finally {
            overlay.style.display = 'none'; 
            showScreen('screen-setup');
        }
    });

    const qCountInput = document.getElementById('q-count');
    const countDisplay = document.getElementById('count-display');
    qCountInput.addEventListener('input', (e) => countDisplay.textContent = e.target.value);

    // --- ã‚²ãƒ¼ãƒ é–‹å§‹ ---
    function startGame() {
        const count = parseInt(qCountInput.value);

        // ã‚¸ãƒ£ãƒ³ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãªã—ã€å…¨ãƒ‡ãƒ¼ã‚¿å¯¾è±¡
        let filteredData = [...database];

        // ãƒ‡ãƒ¼ã‚¿ä¸è¶³æ™‚ã®æ°´å¢—ã—ï¼ˆãƒ«ãƒ¼ãƒ—ã•ã›ã‚‹ï¼‰
        if (filteredData.length === 0) {
            alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼");
            return;
        }
        while (filteredData.length < count) {
            filteredData = filteredData.concat(filteredData);
        }

        shuffleArray(filteredData);
        const selectedData = filteredData.slice(0, count);

        // å…¨ãƒ¯ãƒ¼ãƒ‰å›å
        let wordPool = [];
        selectedData.forEach(item => { wordPool.push(...item.words); });
        shuffleArray(wordPool);

        // è³ªå•æ§‹ç¯‰
        currentQuestions = selectedData.map(item => {
            const slotsCount = (item.template.match(/%s/g) || []).length;
            const allocatedWords = [];
            for(let i=0; i<slotsCount; i++) {
                allocatedWords.push(wordPool.pop() || "è¬");
            }
            return {
                template: item.template,
                allocatedWords: allocatedWords,
                originalWords: item.words
            };
        });

        currentIndex = 0;
        showScreen('screen-play');
        showQuestion();
    }

    function showQuestion() {
        const qData = currentQuestions[currentIndex];
        const counterEl = document.getElementById('question-counter');
        const textEl = document.getElementById('question-text');
        const nextBtn = document.getElementById('next-btn');

        counterEl.textContent = `Q. ${currentIndex + 1} / ${currentQuestions.length}`;
        revealedCount = 0;
        totalSlotsInCurrent = (qData.template.match(/%s/g) || []).length;
        nextBtn.disabled = true;
        if(currentIndex === currentQuestions.length - 1) {
            nextBtn.textContent = "çµæœã‚’è¦‹ã‚‹";
        } else {
            nextBtn.textContent = "æ¬¡ã®è³ªå•ã¸";
        }

        let htmlText = qData.template;
        qData.allocatedWords.forEach(word => {
            htmlText = htmlText.replace('%s', `<span class="shuffled-word" onclick="reveal(this, '${word}')"></span>`);
        });
        textEl.innerHTML = htmlText;
    }

    function reveal(element, word) {
        if (!element.classList.contains('revealed')) {
            element.textContent = word;
            element.classList.add('revealed');
            revealedCount++;
            if (revealedCount >= totalSlotsInCurrent) {
                document.getElementById('next-btn').disabled = false;
            }
        }
    }

    function nextQuestion() {
        if (currentIndex < currentQuestions.length - 1) {
            currentIndex++;
            showQuestion();
        } else {
            showResult();
        }
    }

    function showResult() {
        showScreen('screen-result');
        const listEl = document.getElementById('result-list');
        listEl.innerHTML = '';

        currentQuestions.forEach((q, idx) => {
            let finalText = fillTemplate(q.template, q.allocatedWords);
            let originalText = fillTemplate(q.template, q.originalWords);
            const itemDiv = document.createElement('div');
            itemDiv.className = 'result-item';
            itemDiv.innerHTML = `<div class="result-q">Q${idx+1}. ${finalText}</div><div class="original-text">ï¼ˆå…ƒï¼š${originalText}ï¼‰</div>`;
            listEl.appendChild(itemDiv);
        });
    }

    function fillTemplate(tpl, words) {
        let text = tpl;
        words.forEach(w => { text = text.replace('%s', w); });
        return text;
    }

    function copyResults() {
        let textToCopy = "ã€ã‚·ãƒ£ãƒƒãƒ•ãƒ«100ã®è³ªå•ãƒ¡ãƒ¼ã‚«ãƒ¼ã€‘\n";
        currentQuestions.forEach((q, idx) => {
            let finalText = fillTemplate(q.template, q.allocatedWords);
            textToCopy += `Q${idx+1}. ${finalText}\n`;
        });
        textToCopy += "\n#ã‚·ãƒ£ãƒƒãƒ•ãƒ«100ã®è³ªå•";
        navigator.clipboard.writeText(textToCopy).then(() => {
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        });
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        if(id) document.getElementById(id).classList.add('active');
    }
    function resetGame() { showScreen('screen-setup'); }
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }
</script>

</body>
</html>
